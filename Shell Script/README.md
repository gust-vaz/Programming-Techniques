# EP2 - (Shell Script)

## DESCRIPTION

This is the EP2 assignment for the Programming Techniques 1 course. In summary, it checks the status of the server and the CPU every specified time interval, in addition to calculating the average server downtime and CPU idleness after 100 checks. The program returns the date and time and can provide information about whether the server is down, which IPs are connected to it, and the CPU idleness. Every message is sent to a Telegram bot, the terminal, and a file. The file is updated with new information at each interval, and the CPU idleness is passed to the file at each interval.

Initially, the program checks if the 5 input parameters were passed correctly and calculates `LIM_CPU` as `100 - $3`, which is the minimum CPU idle threshold for the computer.

Entering an "infinite" while loop, the variables are updated. For `CPU_OCIOSA`, it fetches the current idle CPU value, while `FORA_DO_AR` looks for a `LISTEN` entry, which is the information generated by `netstat` showing whether the server is up or not, as well as `ESTABLISHED` for `N_IPS_CONECT`.

If `N_IPS_CONECT` is non-zero, it prints all connected IPs. For CPU idleness, if `CPU_OCIOSA` is below `LIM_CPU`, it will print the idleness both in the terminal and in the file. 

If during the check `FORA_DO_AR` does not show `LISTEN`, it prints that the server is down until it returns and also increments `TEMPO_FORA` with the time of a check, i.e., the time passed as a parameter.

After 100 checks, it prints the average CPU idleness of the last 100 measurements and the time the server was down, stored in `TEMPO_FORA`.

There is a pause based on the time passed before the program starts checking again. The date and time are always sent to Telegram, the terminal, and the file. New information is appended to the end of the file, and the CPU idleness is passed to the file at each interval.

## HOW TO RUN

Open three terminals and execute the following steps in separate terminals:
1. To start the server:
    ```bash
    nc -k -l -p 45052
    ```
2. To connect to the server:
    ```bash
    nc 127.0.0.1 45052
    ```
3. To run the program in the same directory as `EP2.sh`:
    ```bash
    chmod 777 EP2.sh
    ./EP2.sh <$1> <$2> <$3> <$4> <$5>
    ```

Replace the following parameters with:
- `<$1>` = Time interval in seconds for the program to check the system.
- `<$2>` = Path to a file where the checks will be saved.
- `<$3>` = CPU usage percentage limit.
- `<$4>` = Bot token.
- `<$5>` = Bot ID.

The output will appear at the end of the provided file, in the Telegram message, and in the terminal where you ran step 3, specifying all the information described. If the user does not run step 1, it will say "The server is down." If step 2 is not performed, the user's IP will not be displayed, but other connected IPs may still appear.

## TEST CASES

### Input:
```bash
./EP2.sh
```
### Output in terminal:
```
Falta parâmetros
```

Assuming steps 1 and 2 from the previous section have been done, no other IP is connected, and the CPU idleness is 99.5 at a given moment:

### Input:
```bash
./EP2.sh 1 teste.txt 0.2 <Bot Token> <Bot ID>
```

### Output in Telegram and Terminal:
```
=== Nova Verificação do Servidor ===
Data: 15/10/2022 
Hora: 16:15:28
IPs conectados:
127.0.0.1
Ociosidade da CPU:  99.5%
```

### Output in the file:
```
Data: 15/10/2022
Hora: 17:14:50
IPs conectados:
127.0.0.1
Ociosidade da CPU:  99.5%
```

### Output in the file after 100 checks:
```
Media das 100 ultimas medicoes de ociosidade de CPU: 99.95%
Tempo em que o servidor ficou fora do ar nas ultimas 100 medicoes: 0
```

Assuming the user did not perform step 1 or the server went down for an external reason and the CPU idleness is 100.0:

### Input:
```bash
./EP2.sh 1 teste.txt 1 <Bot Token> <Bot ID>
```

### Output in Telegram and Terminal:
```
=== Nova Verificação do Servidor ===
Data: 15/10/2022 
Hora: 16:15:28
O servidor está fora do ar
```

### Output in the file:
```
Data: 15/10/2022
Hora: 17:14:50
Ociosidade da CPU:  100.0%
O servidor esta fora do ar
```

### Output in the file after 100 checks:
```
Media das 100 ultimas medicoes de ociosidade de CPU: 100.00%
Tempo em que o servidor ficou fora do ar nas ultimas 100 medicoes: 100
```

## DEPENDENCIES

- The system language must be set to English, as the program does not interpret "," as a decimal separator and looks for English words when checking the server status.
- Bash version: GNU bash, version 5.0.16(1)-release
- OS version: Ubuntu 20.04 LTS - 64Bits